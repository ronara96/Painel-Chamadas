<script>
        // REMOVIDAS: A funﾃｧﾃ｣o 'falar' e as variﾃ｡veis 'audioEmCurso' e 'window.speechSynthesis'

        let ultimaChamadaFalada = ''; 

        // 圷 CONFIGURAﾃﾃグ FINAL! Sua URL pﾃｺblica da API:
        const URL_API_BASE = 'https://painel-chamadas.onrender.com'; // Sua URL do Render
        
        function getUnidadeIDFromURL() {
            const pathArray = window.location.pathname.split('/');
            return pathArray.pop() || pathArray.pop() || 'UNIDADE_PADRAO'; 
        }

        const UNIDADE_ID = getUnidadeIDFromURL();
        
        document.getElementById('unidade-nome').textContent = `PAINEL DE CHAMADAS | UNIDADE: ${UNIDADE_ID.replace(/_/g, ' ').toUpperCase()}`;

        // --- NOVA FUNﾃﾃグ: Reproduzir ﾃ「dio do Servidor ---
        function reproduzirAudio(audio_file) {
            if (!audio_file) {
                console.error("Nome do arquivo de ﾃ｡udio ausente.");
                return;
            }
            
            // Constrﾃｳi a URL completa para o MP3 no seu servidor Render
            const urlAudio = `${URL_API_BASE}/audio/${audio_file}`;
            
            // Cria um novo elemento de ﾃ｡udio e reproduz
            const audio = new Audio(urlAudio);

            audio.play().catch(e => {
                console.error("Erro ao reproduzir ﾃ｡udio (Pode ser bloqueio de autoplay):", e);
                // Tenta reproduzir novamente apﾃｳs um breve atraso
                setTimeout(() => audio.play().catch(e => console.error("Falha final ao reproduzir ﾃ｡udio.")), 500);
            });
        }

        // Funﾃｧﾃ｣o para atualizar o painel com os dados da API
        async function atualizarPainel() {
            const url = `${URL_API_BASE}/historico/${UNIDADE_ID}`; 
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                const historico = data.historico || [];

                if (historico.length === 0) {
                    // ... (Lﾃｳgica de lista vazia) ...
                    document.getElementById('chamada-atual').classList.add('chamada-vazia');
                    document.getElementById('msg-aguardando').style.display = 'block';
                    document.getElementById('paciente-atual').style.display = 'none';
                    document.getElementById('local-atual').style.display = 'none';
                    document.getElementById('lista-historico').innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                    return;
                }

                document.getElementById('chamada-atual').classList.remove('chamada-vazia');
                document.getElementById('msg-aguardando').style.display = 'none';
                
                // --- 1. Renderiza a Chamada Atual ---
                const chamadaAtual = historico[0];
                const paciente = chamadaAtual.paciente || 'Paciente';
                const local = chamadaAtual.guiche || chamadaAtual.servico || 'Local Desconhecido';
                const audio_file = chamadaAtual.audio_file; // <<< NOVO: Pega o nome do MP3

                // O ID agora inclui o 'audio_file' para garantir unicidade
                const idChamada = chamadaAtual.hora + paciente + local + audio_file; 

                document.getElementById('paciente-atual').textContent = paciente.toUpperCase();
                document.getElementById('local-atual').textContent = local.toUpperCase();

                document.getElementById('paciente-atual').style.display = 'block';
                document.getElementById('local-atual').style.display = 'block';

                
                // 圷 CONTROLE DE ﾃゞDIO (REPRODUﾃﾃグ MP3)
                if (idChamada !== ultimaChamadaFalada && audio_file) {
                    reproduzirAudio(audio_file); // Chama a funﾃｧﾃ｣o que reproduz o MP3 do Render
                    ultimaChamadaFalada = idChamada; // Atualiza o ﾃｺltimo ID falado
                }


                // --- 2. Renderiza o Histﾃｳrico (Sem Alteraﾃｧﾃ｣o) ---
                const listaHistorico = document.getElementById('lista-historico');
                listaHistorico.innerHTML = ''; 

                const chamadosAnteriores = historico.slice(1); 

                if (chamadosAnteriores.length > 0) {
                    const historicoVisivel = chamadosAnteriores.slice(0, 3); 
                    
                    historicoVisivel.forEach(chamado => {
                        const li = document.createElement('li');
                        li.className = 'chamado-historico';
                        const localHistorico = chamado.guiche || chamado.servico || 'Local Desconhecido';
                        
                        li.innerHTML = `
                            <span class="historico-sala">${localHistorico.toUpperCase()}</span> 
                            <span class="historico-paciente">${chamado.paciente.toUpperCase() || 'PACIENTE'}</span>
                        `;
                        listaHistorico.appendChild(li);
                    });
                } else {
                    listaHistorico.innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                }

            } catch (e) {
                console.error('Erro ao buscar dados da API:', e);
                document.getElementById('unidade-nome').textContent = `ERRO: API OFFLINE. TENTANDO...`;
                document.getElementById('chamada-atual').classList.add('chamada-vazia');
                document.getElementById('msg-aguardando').textContent = `ERRO DE CONEXﾃグ`;
                document.getElementById('msg-aguardando').style.display = 'block';
            }
        }

        // Inicia o processo de polling (chama a cada 3 segundos)
        atualizarPainel();
        setInterval(atualizarPainel, 3000); 
    </script>
</body>
</html>
