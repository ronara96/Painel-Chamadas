<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Chamadas - Unificado</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS MODERNOS E ELEGANTES (ALTO CONTRASTE) --- */
        :root {
            --cor-fundo: #1c1c1c; /* Fundo Escuro Moderno */
            --cor-primaria: #007bff; /* Azul Vibrante (Chamada Principal) */
            --cor-destaque: #28a745; /* Verde (Guich√™) */
            --cor-texto-claro: #f8f9fa;
            --cor-sombra: 0 8px 20px rgba(0, 0, 0, 0.4);
            --tempo-animacao: 0.8s;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto-claro);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-rows: 15% 55% 30%; /* T√≠tulo, Principal, Hist√≥rico */
            height: 96vh;
            gap: 20px;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* --- SE√á√ÉO DE T√çTULO --- */
        .header {
            text-align: center;
            padding: 10px 0;
        }
        .header h1 {
            font-size: 2.5vw;
            font-weight: 700;
            color: var(--cor-texto-claro);
            margin: 0;
        }
        #unidade-nome {
            font-size: 1.5vw;
            font-weight: 400;
            color: #ccc;
        }

        /* --- SE√á√ÉO DE CHAMADA PRINCIPAL (DESTAQUE) --- */
        .chamada-principal-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--cor-primaria);
            border-radius: 15px;
            box-shadow: var(--cor-sombra);
            padding: 40px;
            text-align: center;
            transition: background-color var(--tempo-animacao);
            border: 5px solid transparent;
            position: relative;
        }
        
        /* Anima√ß√£o para a chamada principal (efeito de alerta) */
        @keyframes pulse-border {
            0% { border-color: rgba(255, 255, 255, 0.5); }
            50% { border-color: rgba(255, 255, 255, 1); }
            100% { border-color: rgba(255, 255, 255, 0.5); }
        }
        .animar {
             animation: pulse-border 1.5s infinite alternate;
        }

        #chamada-principal-sala {
            font-size: 5vw;
            font-weight: 900;
            color: var(--cor-destaque);
            text-transform: uppercase;
            margin-bottom: 0.1em;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        #chamada-principal-paciente {
            font-size: 12vw; /* Senha GIGANTE */
            font-weight: 900;
            color: var(--cor-texto-claro);
            margin: 0;
            line-height: 1;
        }
        #chamada-principal-paciente::before {
            content: "SENHA: ";
            font-size: 0.2em;
            font-weight: 400;
            display: block;
            opacity: 0.7;
        }
        
        #chamada-principal-hora {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 1.5vw;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.8);
        }

        /* --- SE√á√ÉO DE HIST√ìRICO --- */
        .historico-container {
            background: #2c2c2c;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--cor-sombra);
        }
        .historico-container h2 {
            font-size: 1.8vw;
            font-weight: 700;
            color: #aaa;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .historico-lista {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 20px;
            justify-content: space-around;
        }
        .chamado-historico {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 15px 25px;
            flex-grow: 1;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        .historico-sala {
            font-size: 1.8vw;
            font-weight: 700;
            color: var(--cor-destaque);
            display: block;
            margin-bottom: 5px;
        }
        .historico-paciente {
            font-size: 3vw;
            font-weight: 900;
            color: var(--cor-texto-claro);
            display: block;
        }
        .lista-vazia {
            font-size: 1.5vw;
            color: #777;
            text-align: center;
            width: 100%;
            padding: 20px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>PAINEL DE ATENDIMENTO</h1>
        <span id="unidade-nome">Carregando Unidade...</span>
    </div>

    <div class="chamada-principal-container" id="chamada-principal-box">
        <span id="chamada-principal-sala">Aguardando Chamada</span>
        <span id="chamada-principal-paciente">...</span>
        <span id="chamada-principal-hora"></span>
    </div>

    <div class="historico-container">
        <h2>√öltimas Chamadas</h2>
        <ul class="historico-lista" id="lista-historico">
            <li class="lista-vazia">Aguardando dados da API...</li>
        </ul>
    </div>

    <script>
        // üö® CORRE√á√ÉO CR√çTICA: URL BASE DA API APONTANDO PARA O RENDER
        const API_URL_BASE = 'https://painel-chamadas.onrender.com'; 
        
        let ultimaChamadaRecebida = null;

        // 1. Extra√ß√£o do ID da Unidade da URL
        const urlPartes = window.location.pathname.split('/');
        // Pega a √∫ltima parte da URL (Ex: Aps_Centro_de_Saude_01)
        const UNIDADE_ID = urlPartes[urlPartes.length - 1]; 
        
        // Exibe o nome da unidade no painel e configura a URL da API
        document.getElementById('unidade-nome').textContent = UNIDADE_ID.replace(/_/g, ' ');
        const URL_HISTORICO = `${API_URL_BASE}/historico/${UNIDADE_ID}`;

        // Refer√™ncias do DOM
        const chamadaPrincipalBox = document.getElementById('chamada-principal-box');
        const principalSala = document.getElementById('chamada-principal-sala');
        const principalPaciente = document.getElementById('chamada-principal-paciente');
        const principalHora = document.getElementById('chamada-principal-hora');
        const listaHistorico = document.getElementById('lista-historico');
        
        // Fun√ß√£o principal para buscar e atualizar o painel
        async function atualizarPainel() {
            try {
                const response = await fetch(URL_HISTORICO);
                
                // Se o servidor estiver no ar, mas a rota retornar erro 404/500
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                const chamadosAnteriores = data.historico || [];
                
                if (chamadosAnteriores.length === 0) {
                    principalSala.textContent = 'Aguardando Chamada';
                    principalPaciente.textContent = '...';
                    principalHora.textContent = '';
                    chamadaPrincipalBox.classList.remove('animar');
                    listaHistorico.innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                    return;
                }

                // --- 1. ATUALIZA CHAMADA PRINCIPAL ---
                const chamadaAtual = chamadosAnteriores[0];
                
                // Prioriza o Guich√™, se n√£o existir, usa o Servi√ßo
                const localChamado = chamadaAtual.guiche || chamadaAtual.servico || 'Local Desconhecido';
                
                principalSala.textContent = localChamado;
                principalPaciente.textContent = chamadaAtual.senha || chamadaAtual.paciente || 'SN';
                principalHora.textContent = chamadaAtual.hora || '';


                // --- 2. ANIMA√á√ÉO DE NOVA CHAMADA ---
                const ID_CHAMADA_ATUAL = chamadaAtual.hora + chamadaAtual.senha + localChamado;
                
                if (ID_CHAMADA_ATUAL !== ultimaChamadaRecebida) {
                    // Se for uma nova chamada, adiciona a anima√ß√£o
                    chamadaPrincipalBox.classList.add('animar');
                    ultimaChamadaRecebida = ID_CHAMADA_ATUAL;

                    // Remove a anima√ß√£o ap√≥s 6 segundos para n√£o ser muito intrusiva
                    setTimeout(() => {
                        chamadaPrincipalBox.classList.remove('animar');
                    }, 6000); 
                }
                
                // --- 3. ATUALIZA HIST√ìRICO ---
                listaHistorico.innerHTML = '';
                // Exibe no m√°ximo 2 chamados no hist√≥rico (do √≠ndice 1 em diante)
                const historicoVisivel = chamadosAnteriores.slice(1, 3); 
                
                if (historicoVisivel.length > 0) {
                    historicoVisivel.forEach(chamado => {
                        const li = document.createElement('li');
                        li.className = 'chamado-historico';
                        // Prioriza Guich√™ (Consult√≥rio) para exibi√ß√£o
                        const localHistorico = chamado.guiche || chamado.servico || 'Local Desconhecido';
                        
                        li.innerHTML = `
                            <span class="historico-sala">${localHistorico.toUpperCase()}</span> 
                            <span class="historico-paciente">${chamado.senha || 'SN'}</span>
                        `;
                        listaHistorico.appendChild(li);
                    });
                } else {
                    listaHistorico.innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                }

            } catch (e) {
                console.error('Erro ao buscar dados da API (Verifique o Render):', e);
                // Exibe a mensagem de erro no painel se a comunica√ß√£o falhar
                principalSala.textContent = `ERRO DE CONEX√ÉO`;
                principalPaciente.textContent = `API OFFLINE`;
                principalHora.textContent = '';
                chamadaPrincipalBox.classList.remove('animar');
            }
        }

        // Inicia o processo de polling (chama a cada 3 segundos)
        atualizarPainel();
        // A taxa de atualiza√ß√£o √© r√°pida para garantir a responsividade
        setInterval(atualizarPainel, 3000); 
    </script>
</body>
</html>