<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Chamadas - Unificado</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS ORIGINAIS (CLARO) --- */
        :root {
            --cor-azul-principal: #007bff;      /* Azul Vibrante (Fundo Chamada) */
            --cor-verde-destaque: #28a745;      /* Verde Destaque (Guich√™/Servi√ßo) */
            --cor-fundo-claro: #f8f9fa;         /* Fundo Geral */
            --cor-texto-principal: #333;        /* Texto Escuro */
            --cor-texto-claro: #fff;            /* Texto na Chamada Principal */
            --cor-sombra: 0 4px 12px rgba(0, 0, 0, 0.15);
            --tempo-animacao: 0.5s;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--cor-fundo-claro);
            color: var(--cor-texto-principal);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-rows: 15% 55% 30%; /* T√≠tulo, Principal, Hist√≥rico */
            height: 96vh;
            gap: 20px;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* --- SE√á√ÉO DE T√çTULO --- */
        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 2px solid #ccc;
        }
        .header h1 {
            font-size: 2.5vw;
            font-weight: 700;
            color: var(--cor-texto-principal);
            margin: 0;
        }
        #unidade-nome {
            font-size: 1.5vw;
            font-weight: 400;
            color: var(--cor-azul-principal);
        }

        /* --- SE√á√ÉO DE CHAMADA PRINCIPAL (DESTAQUE) --- */
        .chamada-principal-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--cor-azul-principal);
            border-radius: 15px;
            box-shadow: var(--cor-sombra);
            padding: 40px;
            text-align: center;
            transition: background-color var(--tempo-animacao);
            border: 5px solid transparent;
            position: relative;
        }
        
        /* Anima√ß√£o para a chamada principal (efeito de alerta) */
        @keyframes pulse-border {
            0% { border-color: rgba(255, 255, 255, 0.5); }
            50% { border-color: rgba(255, 255, 255, 1); }
            100% { border-color: rgba(255, 255, 255, 0.5); }
        }
        .animar {
             animation: pulse-border 1.5s infinite alternate;
        }

        #chamada-principal-sala {
            font-size: 5vw;
            font-weight: 900;
            color: var(--cor-verde-destaque); /* Guich√™ em destaque verde */
            text-transform: uppercase;
            margin-bottom: 0.1em;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        #chamada-principal-paciente {
            font-size: 8vw; /* Nome do Paciente */
            font-weight: 900;
            color: var(--cor-texto-claro);
            margin: 0;
            line-height: 1.2;
        }
        #chamada-principal-paciente::before {
            content: "PACIENTE: ";
            font-size: 0.2em;
            font-weight: 400;
            display: block;
            opacity: 0.7;
        }
        
        #chamada-principal-hora {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 1.5vw;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.8);
        }

        /* --- SE√á√ÉO DE HIST√ìRICO --- */
        .historico-container {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--cor-sombra);
        }
        .historico-container h2 {
            font-size: 1.8vw;
            font-weight: 700;
            color: var(--cor-texto-principal);
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .historico-lista {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 20px;
            justify-content: space-around;
        }
        .chamado-historico {
            background: #f1f1f1;
            border-radius: 8px;
            padding: 15px 25px;
            flex-grow: 1;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .historico-sala {
            font-size: 1.8vw;
            font-weight: 700;
            color: var(--cor-verde-destaque);
            display: block;
            margin-bottom: 5px;
        }
        .historico-paciente {
            font-size: 3vw;
            font-weight: 900;
            color: var(--cor-texto-principal);
            display: block;
        }
        .lista-vazia {
            font-size: 1.5vw;
            color: #777;
            text-align: center;
            width: 100%;
            padding: 20px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>PAINEL DE ATENDIMENTO</h1>
        <span id="unidade-nome">Carregando Unidade...</span>
    </div>

    <div class="chamada-principal-container" id="chamada-principal-box">
        <span id="chamada-principal-sala">Aguardando Chamada</span>
        <span id="chamada-principal-paciente">...</span>
        <span id="chamada-principal-hora"></span>
    </div>

    <div class="historico-container">
        <h2>√öltimas Chamadas</h2>
        <ul class="historico-lista" id="lista-historico">
            <li class="lista-vazia">Aguardando dados da API...</li>
        </ul>
    </div>

    <script>
        // üö® LINHA CR√çTICA 1: URL BASE DA API APONTANDO PARA O RENDER
        const API_URL_BASE = 'https://painel-chamadas.onrender.com'; 
        
        let ultimaChamadaRecebida = null;
        let ultimaFalaLida = null; // Para controlar o √°udio

        // 1. Extra√ß√£o do ID da Unidade da URL
        const urlPartes = window.location.pathname.split('/');
        // Pega a √∫ltima parte da URL (Ex: Aps_Centro_de_Saude_01)
        const UNIDADE_ID = urlPartes[urlPartes.length - 1]; 
        
        // Exibe o nome da unidade no painel e configura a URL da API
        document.getElementById('unidade-nome').textContent = UNIDADE_ID.replace(/_/g, ' ');
        const URL_HISTORICO = `${API_URL_BASE}/historico/${UNIDADE_ID}`;

        // Refer√™ncias do DOM
        const chamadaPrincipalBox = document.getElementById('chamada-principal-box');
        const principalSala = document.getElementById('chamada-principal-sala');
        const principalPaciente = document.getElementById('chamada-principal-paciente');
        const principalHora = document.getElementById('chamada-principal-hora');
        const listaHistorico = document.getElementById('lista-historico');
        
        // --- FUN√á√ÉO DE √ÅUDIO ---
        function falarChamada(paciente, destino) {
            if (!('speechSynthesis' in window)) {
                console.warn("API de S√≠ntese de Voz n√£o suportada neste navegador.");
                return;
            }

            // Frase de exemplo: "Maria Souza favor se dirigir ao consultorio 3 para a consulta"
            const utterance = new SpeechSynthesisUtterance(`${paciente} favor se dirigir ao ${destino} para o atendimento.`);
            
            // Configura√ß√µes (Voz masculina BR se dispon√≠vel)
            utterance.lang = 'pt-BR';
            utterance.rate = 1.0; // Velocidade
            utterance.pitch = 1.0; // Tonalidade
            
            // Tenta encontrar uma voz masculina (adapt√°vel)
            window.speechSynthesis.onvoiceschanged = () => {
                const voices = window.speechSynthesis.getVoices();
                // Tenta achar uma voz masculina em portugu√™s (pode variar o nome)
                let voz = voices.find(v => v.lang === 'pt-BR' && (v.name.includes('male') || v.name.includes('Google portugu√™s do Brasil') || v.name.includes('Microsoft Daniel')));
                
                if (voz) {
                    utterance.voice = voz;
                } else {
                    // Usa a primeira voz em portugu√™s se n√£o encontrar a masculina
                    voz = voices.find(v => v.lang === 'pt-BR');
                    if(voz) utterance.voice = voz;
                }
            };
            
            window.speechSynthesis.speak(utterance);
        }

        // Fun√ß√£o principal para buscar e atualizar o painel
        async function atualizarPainel() {
            try {
                const response = await fetch(URL_HISTORICO);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                const chamadosAnteriores = data.historico || [];
                
                // Garante que o nome da unidade esteja correto ap√≥s uma comunica√ß√£o bem-sucedida
                document.getElementById('unidade-nome').textContent = UNIDADE_ID.replace(/_/g, ' ');

                if (chamadosAnteriores.length === 0) {
                    principalSala.textContent = 'Aguardando Chamada';
                    principalPaciente.textContent = '...';
                    principalHora.textContent = '';
                    chamadaPrincipalBox.classList.remove('animar');
                    listaHistorico.innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                    return;
                }

                // --- 1. ATUALIZA CHAMADA PRINCIPAL ---
                const chamadaAtual = chamadosAnteriores[0];
                
                // Prioriza o Guich√™ (Consult√≥rio ou Servi√ßo)
                const localChamado = chamadaAtual.guiche || chamadaAtual.servico || 'Local Desconhecido';
                const nomePaciente = chamadaAtual.paciente || chamadaAtual.senha || 'Paciente N√£o Identificado';
                
                principalSala.textContent = localChamado;
                
                // üö® L√ìGICA CORRIGIDA: Prioriza o nome do paciente, que √© o dado real enviado pela Extens√£o.
                principalPaciente.textContent = nomePaciente; 
                
                principalHora.textContent = chamadaAtual.hora || '';


                // --- 2. ANIMA√á√ÉO E √ÅUDIO DE NOVA CHAMADA ---
                const ID_CHAMADA_ATUAL = localChamado + nomePaciente + chamadaAtual.hora; 
                
                if (ID_CHAMADA_ATUAL !== ultimaChamadaRecebida) {
                    // Se for uma nova chamada, adiciona a anima√ß√£o
                    chamadaPrincipalBox.classList.add('animar');
                    ultimaChamadaRecebida = ID_CHAMADA_ATUAL;

                    // üîâ Toca o √°udio APENAS se a chamada for realmente nova
                    if (ID_CHAMADA_ATUAL !== ultimaFalaLida) {
                        falarChamada(nomePaciente, localChamado);
                        ultimaFalaLida = ID_CHAMADA_ATUAL;
                    }
                    
                    // Remove a anima√ß√£o ap√≥s 6 segundos 
                    setTimeout(() => {
                        chamadaPrincipalBox.classList.remove('animar');
                    }, 6000); 
                }
                
                // --- 3. ATUALIZA HIST√ìRICO ---
                listaHistorico.innerHTML = '';
                // Exibe no m√°ximo 2 chamados no hist√≥rico (do √≠ndice 1 em diante)
                const historicoVisivel = chamadosAnteriores.slice(1, 3); 
                
                if (historicoVisivel.length > 0) {
                    historicoVisivel.forEach(chamado => {
                        const li = document.createElement('li');
                        li.className = 'chamado-historico';
                        // Prioriza Guich√™ (Consult√≥rio) para exibi√ß√£o
                        const localHistorico = chamado.guiche || chamado.servico || 'Local Desconhecido';
                        
                        li.innerHTML = `
                            <span class="historico-sala">${localHistorico.toUpperCase()}</span> 
                            <span class="historico-paciente">${chamado.paciente || 'SN'}</span>
                        `;
                        listaHistorico.appendChild(li);
                    });
                } else {
                    listaHistorico.innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                }

            } catch (e) {
                console.error('Erro ao buscar dados da API (Verifique o Render):', e);
                // Exibi√ß√£o do erro na √°rea de destaque
                document.getElementById('unidade-nome').textContent = 'Erro de Comunica√ß√£o - Tentando Reconectar...'; // Mant√©m o nome da unidade no cabe√ßalho
                principalSala.textContent = `ERRO DE CONEX√ÉO`;
                principalPaciente.textContent = `API OFFLINE`;
                principalHora.textContent = '';
                chamadaPrincipalBox.classList.remove('animar');
            }
        }

        // Inicia o processo de polling (chama a cada 3 segundos)
        atualizarPainel();
        // A taxa de atualiza√ß√£o √© r√°pida para garantir a responsividade
        setInterval(atualizarPainel, 3000); 
    </script>
</body>
</html>
