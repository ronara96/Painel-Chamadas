<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Chamadas - Unificado</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS MODERNOS, ELEGANTES E DE ALTA LEGIBILIDADE --- */
        :root {
            --cor-fundo-claro: #F0F4F8;       /* Fundo Gelo/Claro */
            --cor-azul-principal: #174776;    /* Azul Escuro Profissional (Bloco Principal) */
            --cor-verde-destaque: #28a745;    /* Verde Destaque (Guich√™/Servi√ßo - Chamada Ativa) */
            --cor-texto-escuro: #333333;      /* Preto Suave para Legibilidade */
            --cor-texto-claro: #FFFFFF;       /* Branco (dentro do bloco azul) */
            --cor-sombra: 0 10px 25px rgba(0, 0, 0, 0.2); /* Sombra Elegante */
            --tempo-animacao: 0.5s;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--cor-fundo-claro);
            color: var(--cor-texto-escuro);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-rows: 15% 55% 30%; /* T√≠tulo, Principal, Hist√≥rico */
            height: 96vh;
            gap: 20px;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* --- SE√á√ÉO DE T√çTULO --- */
        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 3px solid #E0E0E0;
        }
        .header h1 {
            font-size: 2.8vw;
            font-weight: 900;
            color: var(--cor-texto-escuro);
            margin: 0;
        }
        #unidade-nome {
            font-size: 1.8vw;
            font-weight: 700;
            color: var(--cor-azul-principal);
        }

        /* --- SE√á√ÉO DE CHAMADA PRINCIPAL (DESTAQUE) --- */
        .chamada-principal-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--cor-azul-principal);
            border-radius: 20px;
            box-shadow: var(--cor-sombra);
            padding: 50px;
            text-align: center;
            transition: transform var(--tempo-animacao);
            border: 8px solid transparent;
            position: relative;
        }
        
        /* Anima√ß√£o de Pulsar para a Chamada */
        @keyframes pulse-border {
            0% { border-color: rgba(255, 255, 255, 0.4); }
            50% { border-color: var(--cor-verde-destaque); }
            100% { border-color: rgba(255, 255, 255, 0.4); }
        }
        .animar {
             animation: pulse-border 1.5s infinite alternate;
        }

        #chamada-principal-sala {
            font-size: 6vw;
            font-weight: 900;
            color: var(--cor-verde-destaque); /* Cor ATIVA: Verde para o Consult√≥rio/Servi√ßo */
            text-transform: uppercase;
            margin-bottom: 0.1em;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            transition: color 0.5s, font-size 0.5s; 
        }
        
        /* üö® CLASSE PARA MODO IDLE (AGUARDANDO) - Deixa a mensagem compacta e branca */
        .idle-status-text {
            color: var(--cor-texto-claro) !important; 
            opacity: 0.9;
            font-size: 5vw !important; /* Fonte menor para a mensagem de espera */
            font-weight: 700 !important;
            margin-bottom: 0 !important;
        }
        
        #chamada-principal-paciente {
            font-size: 10vw; 
            font-weight: 900;
            color: var(--cor-texto-claro);
            margin: 0;
            line-height: 1.1;
            transition: color 0.5s, font-size 0.5s; 
        }
        
        /* O "PACIENTE:" desaparece no modo idle, mas aparece no modo ativo */
        #chamada-principal-paciente::before {
            content: "PACIENTE: ";
            font-size: 0.2em;
            font-weight: 400;
            display: block;
            opacity: 0.8;
            color: #ccc;
        }
        .idle-status-text::before {
            content: none !important;
        }
        
        #chamada-principal-hora {
            position: absolute;
            top: 25px;
            right: 35px;
            font-size: 1.8vw;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.6);
        }

        /* --- SE√á√ÉO DE HIST√ìRICO --- */
        .historico-container {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .historico-container h2 {
            font-size: 2.2vw;
            font-weight: 700;
            color: var(--cor-texto-escuro);
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .historico-lista {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 20px;
            justify-content: space-around;
        }
        .chamado-historico {
            background: #f1f1f1;
            border-radius: 10px;
            padding: 15px 25px;
            flex-grow: 1;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--cor-azul-principal);
        }
        .historico-sala {
            font-size: 1.8vw;
            font-weight: 700;
            color: var(--cor-verde-destaque);
            display: block;
            margin-bottom: 5px;
        }
        .historico-paciente {
            font-size: 3vw;
            font-weight: 900;
            color: var(--cor-texto-escuro);
            display: block;
        }
        .lista-vazia {
            font-size: 1.5vw;
            color: #777;
            text-align: center;
            width: 100%;
            padding: 20px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>PAINEL DE ATENDIMENTO</h1>
        <span id="unidade-nome">Carregando Unidade...</span>
    </div>

    <div class="chamada-principal-container" id="chamada-principal-box">
        <span id="chamada-principal-sala">Aguardando Chamada</span>
        <span id="chamada-principal-paciente">...</span>
        <span id="chamada-principal-hora"></span>
    </div>

    <div class="historico-container">
        <h2>√öltimas Chamadas</h2>
        <ul class="historico-lista" id="lista-historico">
            <li class="lista-vazia">Aguardando dados da API...</li>
        </ul>
    </div>

    <script>
        // üö® LINHA CR√çTICA 1: URL BASE DA API APONTANDO PARA O RENDER
        const API_URL_BASE = 'https://painel-chamadas.onrender.com'; 
        
        let ultimaChamadaRecebida = null;
        let ultimaFalaLida = null; // Para controlar o √°udio

        // 1. Extra√ß√£o do ID da Unidade da URL
        const urlPartes = window.location.pathname.split('/');
        const UNIDADE_ID = urlPartes[urlPartes.length - 1]; 
        
        document.getElementById('unidade-nome').textContent = UNIDADE_ID.replace(/_/g, ' ');
        const URL_HISTORICO = `${API_URL_BASE}/historico/${UNIDADE_ID}`;

        // Refer√™ncias do DOM
        const chamadaPrincipalBox = document.getElementById('chamada-principal-box');
        const principalSala = document.getElementById('chamada-principal-sala');
        const principalPaciente = document.getElementById('chamada-principal-paciente');
        const principalHora = document.getElementById('chamada-principal-hora');
        const listaHistorico = document.getElementById('lista-historico');
        
        // --- FUN√á√ÉO DE √ÅUDIO ---
        function falarChamada(paciente, destino) {
            if (!('speechSynthesis' in window)) {
                console.warn("API de S√≠ntese de Voz n√£o suportada neste navegador.");
                return;
            }

            const utterance = new SpeechSynthesisUtterance(`${paciente}, favor se dirigir ao ${destino} para o atendimento.`);
            
            utterance.lang = 'pt-BR';
            utterance.rate = 1.0; 
            utterance.pitch = 1.0; 
            
            const setVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                let voz = voices.find(v => v.lang.includes('pt') && (v.name.toLowerCase().includes('male') || v.name.toLowerCase().includes('daniel') || v.name.includes('Google portugu√™s do Brasil')));
                
                if (!voz) {
                    voz = voices.find(v => v.lang.includes('pt'));
                }
                
                if (voz) {
                    utterance.voice = voz;
                }
                window.speechSynthesis.speak(utterance);
            };

            if (window.speechSynthesis.getVoices().length > 0) {
                setVoice();
            } else {
                window.speechSynthesis.onvoiceschanged = setVoice;
            }
        }

        // Fun√ß√£o principal para buscar e atualizar o painel
        async function atualizarPainel() {
            try {
                const response = await fetch(URL_HISTORICO);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                const chamadosAnteriores = data.historico || [];
                
                document.getElementById('unidade-nome').textContent = UNIDADE_ID.replace(/_/g, ' ');
                
                // üö® LINHA DE DEBUG: VERIFICA SE O DADO EST√Å CHEGANDO!
                console.log('API retornou chamados:', chamadosAnteriores.length);
                
                if (chamadosAnteriores.length === 0) {
                    // MODO IDLE ATIVADO: Mensagem √∫nica e compacta no local do Servi√ßo/Consult√≥rio
                    principalSala.textContent = 'AGUARDANDO PR√ìXIMA CHAMADA'; 
                    principalPaciente.textContent = ''; // Campo paciente VAZIO
                    principalHora.textContent = '';
                    chamadaPrincipalBox.classList.remove('animar');
                    listaHistorico.innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                    
                    // Adiciona a classe para for√ßar a cor e tamanho compactos
                    principalSala.classList.add('idle-status-text');
                    principalPaciente.classList.add('idle-status-text');
                    return;
                }

                // MODO ATIVO: Remove a classe idle para usar o estilo normal
                principalSala.classList.remove('idle-status-text');
                principalPaciente.classList.remove('idle-status-text');


                // --- 1. ATUALIZA CHAMADA PRINCIPAL ---
                const chamadaAtual = chamadosAnteriores[0];
                
                const localChamado = chamadaAtual.guiche || chamadaAtual.servico || 'Local Desconhecido';
                const nomePaciente = chamadaAtual.paciente || chamadaAtual.senha || 'Paciente N√£o Identificado';
                
                principalSala.textContent = localChamado;
                principalPaciente.textContent = nomePaciente;
                principalHora.textContent = chamadaAtual.hora || '';


                // --- 2. ANIMA√á√ÉO E √ÅUDIO DE NOVA CHAMADA ---
                const ID_CHAMADA_ATUAL = localChamado + nomePaciente + chamadaAtual.hora; 
                
                if (ID_CHAMADA_ATUAL !== ultimaChamadaRecebida) {
                    chamadaPrincipalBox.classList.add('animar');
                    ultimaChamadaRecebida = ID_CHAMADA_ATUAL;

                    if (ID_CHAMADA_ATUAL !== ultimaFalaLida) {
                        falarChamada(nomePaciente, localChamado);
                        ultimaFalaLida = ID_CHAMADA_ATUAL;
                    }
                    
                    setTimeout(() => {
                        chamadaPrincipalBox.classList.remove('animar');
                    }, 6000); 
                }
                
                // --- 3. ATUALIZA HIST√ìRICO ---
                listaHistorico.innerHTML = '';
                const historicoVisivel = chamadosAnteriores.slice(1, 3); 
                
                if (historicoVisivel.length > 0) {
                    historicoVisivel.forEach(chamado => {
                        const li = document.createElement('li');
                        li.className = 'chamado-historico';
                        const localHistorico = chamado.guiche || chamado.servico || 'Local Desconhecido';
                        
                        li.innerHTML = `
                            <span class="historico-sala">${localHistorico.toUpperCase()}</span> 
                            <span class="historico-paciente">${chamado.paciente || 'SN'}</span>
                        `;
                        listaHistorico.appendChild(li);
                    });
                } else {
                    listaHistorico.innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                }

            } catch (e) {
                console.error('Erro ao buscar dados da API (Verifique o Render):', e);
                // Exibi√ß√£o do erro na √°rea de destaque
                document.getElementById('unidade-nome').textContent = 'Erro de Comunica√ß√£o - Tentando Reconectar...';
                principalSala.textContent = `ERRO DE CONEX√ÉO`;
                principalPaciente.textContent = `API OFFLINE`;
                principalHora.textContent = '';
                chamadaPrincipalBox.classList.remove('animar');
                
                // Garante que o erro de conex√£o tamb√©m seja em destaque branco
                principalSala.classList.add('idle-status-text');
                principalPaciente.classList.add('idle-status-text');
            }
        }

        // Inicia o processo de polling (chama a cada 3 segundos)
        atualizarPainel();
        setInterval(atualizarPainel, 3000); 
    </script>
</body>
</html>
