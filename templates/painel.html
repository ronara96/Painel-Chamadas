<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        
        let ultimaChamadaFalada = ''; 
        const URL_API_BASE = 'https://painel-chamadas.onrender.com'; 
        
        // --- Fun칞칫es Auxiliares ---

        function getUnidadeIDFromURL() {
            const pathArray = window.location.pathname.split('/');
            return pathArray.pop() || pathArray.pop() || 'UNIDADE_PADRAO'; 
        }

        const UNIDADE_ID = getUnidadeIDFromURL();
        
        document.getElementById('unidade-nome').textContent = `PAINEL DE CHAMADAS | UNIDADE: ${UNIDADE_ID.replace(/_/g, ' ').toUpperCase()}`;

        // --- FUN칂츾O DE REPRODU칂츾O FINAL (Voz Robusta Garantida) ---
        function reproduzirAudio(frase_audio) {
            if (!frase_audio) return;
            
            // Constr칩i a URL para a voz robusta no servidor Render
            const urlAudio = `${URL_API_BASE}/gerar_audio?texto=${encodeURIComponent(frase_audio)}`;
            const audio = new Audio(urlAudio);

            // Apenas toca o 치udio. Esperamos que a permiss칚o da TV funcione.
            audio.play().catch(e => {
                console.error("ERRO CR칈TICO DE REPRODU칂츾O: O 치udio da TV falhou no play(). Verifique o volume ou o formato do MP3:", e);
                // Tenta reproduzir novamente ap칩s um breve atraso
                setTimeout(() => audio.play().catch(e => console.error("Falha final ao reproduzir.")), 100);
            });
        }

        // Fun칞칚o para atualizar o painel com os dados da API
        async function atualizarPainel() {
            const url = `${URL_API_BASE}/historico/${UNIDADE_ID}`; 
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                const historico = data.historico || [];

                // --- Se n칚o houver chamadas, exibe a mensagem de espera ---
                if (historico.length === 0) {
                    document.getElementById('chamada-atual').classList.add('chamada-vazia');
                    document.getElementById('msg-aguardando').style.display = 'block';
                    document.getElementById('paciente-atual').style.display = 'none';
                    document.getElementById('local-atual').style.display = 'none';
                    document.getElementById('lista-historico').innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                    return;
                }

                document.getElementById('chamada-atual').classList.remove('chamada-vazia');
                document.getElementById('msg-aguardando').style.display = 'none';
                
                // --- 1. Renderiza a Chamada Atual ---
                const chamadaAtual = historico[0];
                const paciente = chamadaAtual.paciente || 'Paciente';
                const local = chamadaAtual.guiche || chamadaAtual.servico || 'Local Desconhecido';
                const frase_audio = chamadaAtual.frase_audio; // Frase completa (nome do paciente + destino)

                // ID para controle de repeti칞칚o
                const idChamada = chamadaAtual.hora + frase_audio; 

                document.getElementById('paciente-atual').textContent = paciente.toUpperCase();
                document.getElementById('local-atual').textContent = local.toUpperCase();

                document.getElementById('paciente-atual').style.display = 'block';
                document.getElementById('local-atual').style.display = 'block';
                
                // 游뚿 CONTROLE DE 츼UDIO 
                if (idChamada !== ultimaChamadaFalada && frase_audio) {
                    reproduzirAudio(frase_audio); // Toca a voz robusta automaticamente
                    ultimaChamadaFalada = idChamada; 
                }
                
                // --- 2. Renderiza o Hist칩rico (Sem Altera칞칚o) ---
                const listaHistorico = document.getElementById('lista-historico');
                listaHistorico.innerHTML = ''; 

                const chamadosAnteriores = historico.slice(1); 

                if (chamadosAnteriores.length > 0) {
                    const historicoVisivel = chamadosAnteriores.slice(0, 3); 
                    
                    historicoVisivel.forEach(chamado => {
                        const li = document.createElement('li');
                        li.className = 'chamado-historico';
                        const localHistorico = chamado.guiche || chamado.servico || 'Local Desconhecido';
                        
                        li.innerHTML = `
                            <span class="historico-sala">${localHistorico.toUpperCase()}</span> 
                            <span class="historico-paciente">${(chamado.paciente || 'PACIENTE').toUpperCase()}</span>
                        `;
                        listaHistorico.appendChild(li);
                    });
                } else {
                    listaHistorico.innerHTML = '<li class="lista-vazia">Nenhum chamado anterior.</li>';
                }

            } catch (e) {
                console.error('Erro ao buscar dados da API:', e);
                document.getElementById('unidade-nome').textContent = `ERRO: API OFFLINE. TENTANDO...`;
                document.getElementById('chamada-atual').classList.add('chamada-vazia');
                document.getElementById('msg-aguardando').textContent = `ERRO DE CONEX츾O`;
                document.getElementById('msg-aguardando').style.display = 'block';
            }
        }

        // Inicia o processo de polling (chama a cada 3 segundos)
        atualizarPainel();
        setInterval(atualizarPainel, 3000); 
    });
</script>
